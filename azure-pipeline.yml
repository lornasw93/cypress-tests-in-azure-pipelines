# /home/vsts/work/1/s == $(Build.SourcesDirectory)

trigger:
  paths:
    include:
      - master

variables:
  CypressFolderPath: '/home/vsts/work/1/s/cypress'

pool:
  vmImage: 'ubuntu-latest'

jobs:
- job: Job_1
  displayName: Pre-requisites
  steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Install Node.js'

  - script: npm ci
    displayName: 'Install NPM dependencies'

  - script: npm run cy:verify
    displayName: 'Verify Cypress is installed'

  - script: |
      npm install -g wait-on
      npm run start:e2e & wait-on http://localhost:4173 & npm run cy:run-junit-reporter:e2e
    continueOnError: True
    displayName: 'Run e2e tests'

  # - script: npm run cy:run-junit-reporter:component
  #   displayName: 'Run Cypress component tests'

- job: Job_2
  dependsOn: Job_1
  condition: eq(dependencies.Job_1.result,'Succeeded')
  displayName: Publish success results
  steps:
  - task: PublishTestResults@2
    displayName: 'Publish test results'
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '$(Build.SourcesDirectory)/cypress/results/result-*.xml'
      # mergeTestResults: true
      testRunTitle: 'Basic Cypress tests'
      searchFolder: '$(System.DefaultWorkingDirectory)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish videos'
    condition: succeededOrFailed()
    continueOnError: True
    inputs:
      PathtoPublish: '$(SourcesDirectory)/cypress/videos'
      ArtifactName: videos

- job: Job_3
  dependsOn: Job_1
  condition: eq(dependencies.Job_1.result,'SucceededWithIssues')
  displayName: Publish failed results
  steps:
  - task: PublishTestResults@2
    displayName: 'Publish test results'
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '$(Build.SourcesDirectory)/cypress/results/result-*.xml'
      # mergeTestResults: true
      testRunTitle: 'Basic Cypress tests'
      searchFolder: '$(System.DefaultWorkingDirectory)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish screenshots'
    condition: succeededOrFailed()
    continueOnError: True
    inputs:
      PathtoPublish: '$(SourcesDirectory)/cypress/screenshots'
      ArtifactName: screenshots

  - task: PublishBuildArtifacts@1
    displayName: 'Publish videos'
    condition: succeededOrFailed()
    continueOnError: True
    inputs:
      PathtoPublish: '$(SourcesDirectory)/cypress/videos'
      ArtifactName: videos
